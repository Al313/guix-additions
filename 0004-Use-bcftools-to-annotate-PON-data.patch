From e308f82ec2ba39184294ad674acff06b86f5dd8b Mon Sep 17 00:00:00 2001
From: Roel Janssen <roel@gnu.org>
Date: Mon, 19 Feb 2018 13:42:40 +0100
Subject: [PATCH] Use bcftools to annotate PON data.

* templates/StrelkaPostProcess.sh.tt: Make annotatePON.py obsolete.
---
 templates/StrelkaPostProcess.sh.tt | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/templates/StrelkaPostProcess.sh.tt b/templates/StrelkaPostProcess.sh.tt
index f8ca851..2cb7f46 100644
--- a/share/hmf-pipeline/templates/StrelkaPostProcess.sh.tt
+++ b/share/hmf-pipeline/templates/StrelkaPostProcess.sh.tt
@@ -66,19 +66,27 @@ java -Xmx[% opt.STRELKAPOSTPROCESS_MEM %]G \
     --dbsnp "[% opt.ANNOTATE_IDDB %]" \
     --alwaysAppendDbsnpId
 
+[% opt.PBGZIP_PATH %]/pbgzip "$output_vcf"
+
+assert_last_position_unchanged "$input_vcf" "$output_vcf"
+rm "$input_vcf" "$input_vcf.idx"
+input_vcf="${output_vcf}.gz"
+output_vcf="$basefile".annotated.pon.vcf.gz
+rm -f "$output_vcf" "$output_vcf.idx"
+
+[% opt.BCFTOOLS_PATH %]/bcftools annotate -a "[% opt.HMF_PON %]" -c PON_COUNT ${input_vcf} -o ${output_vcf} -O z
+
 assert_last_position_unchanged "$input_vcf" "$output_vcf"
 rm "$input_vcf" "$input_vcf.idx"
 input_vcf="$output_vcf"
-output_vcf="$basefile".pon.vcf
+output_vcf="$basefile".filtered.pon.vcf.gz
 rm -f "$output_vcf" "$output_vcf.idx"
 
-[% opt.OUTPUT_DIR %]/scripts/annotatePON.py -p "[% opt.HMF_PON %]" -i "$input_vcf" -o - | \
 [% opt.BCFTOOLS_PATH %]/bcftools filter -e 'PON_COUNT!="." && MIN(PON_COUNT) > 5' -s PON -m+ -o "$output_vcf"
 [% opt.IGVTOOLS_PATH %]/igvtools index "$output_vcf"
 
 assert_last_position_unchanged "$input_vcf" "$output_vcf"
 rm "$input_vcf" "$input_vcf.idx"
-
 mv "$output_vcf" "[% final_vcf %]"
 mv "$output_vcf.idx" "[% final_vcf %].idx"
 success
-- 
2.15.0

